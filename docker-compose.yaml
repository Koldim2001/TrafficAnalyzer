version: '3.8'

services:

  backend_traffic_analyzer:
    build: .
    restart: always
    container_name: backend_traffic_analyzer
    command: python main_optimized.py
    environment:
      - VIDEO_SRC=test_videos/test_video.mp4
      - ROADS_JSON=configs/entry_exit_lanes.json
      - TABLE_NAME=traffic_info
      - DROP_TABLE=True
      - USER_DB=user
      - PASSWORD_DB=pwd
    volumes:
      - .:/app
    ports:
      - "8100:8100"
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: all
              capabilities: [gpu]
    networks:
      - prod_network

  pg_data_wh:
    container_name: pg_data_wh
    image: postgres:15
    restart: always
    environment:
      POSTGRES_DB: traffic_analyzer_db
      POSTGRES_USER: user
      POSTGRES_PASSWORD: pwd
    ports:
      - "5488:5432"
    volumes:
      - ./services/pg_data_wh:/var/lib/postgresql/data
    networks:
      - prod_network

  grafana:
    container_name: grafana_building
    image: grafana/grafana:latest
    environment:
      TZ: "Europe/Moscow"
      GF_SECURITY_ADMIN_USER: admin
      GF_SECURITY_ADMIN_PASSWORD: admin
      GF_ALLOW_EMBEDDING: true
      GF_PANELS_DISABLE_SANITIZE_HTML: true
    restart: unless-stopped
    ports:
      - "3111:3000"
    volumes:
      - ./services/grafana:/var/lib/grafana
    networks:
      - prod_network

volumes:
  pg_data_wh:
  pg_grafana:
  grafana:

networks:
  prod_network:
    driver: bridge

version: '3.8'

services:

  traffic_analyzer_camera_1:
    build: .
    image: traffic_analyzer/traffic_analyzer_triton:latest 
    restart: always
    container_name: traffic_analyzer_camera_1
    command: python main_optimized.py
    environment:
      - VIDEO_SRC=test_videos/test_video.mp4
      - ROADS_JSON=configs/entry_exit_lanes.json
      - TABLE_NAME=traffic_info_1
      - DROP_TABLE=False
    volumes:
      - ./configs:/app/configs
      - ./weights:/app/weights
      - ./test_videos:/app/test_videos
    networks:
      - prod_network
    env_file: 
      - secrets.txt

  traffic_analyzer_camera_2:
    image: traffic_analyzer/traffic_analyzer_triton:latest 
    restart: always
    container_name: traffic_analyzer_camera_2
    command: python main_optimized.py
    environment:
      - VIDEO_SRC=test_videos/longer_example.mp4
      - ROADS_JSON=configs/entry_exit_lanes.json
      - TABLE_NAME=traffic_info_2
      - DROP_TABLE=False
    volumes:
      - ./configs:/app/configs
      - ./weights:/app/weights
      - ./test_videos:/app/test_videos
    networks:
      - prod_network
    env_file: 
      - secrets.txt

  nginx:
    image: nginx:latest
    container_name: nginx
    restart: always
    volumes:
      - ./services/nginx/nginx.conf:/etc/nginx/nginx.conf 
    ports:
      - 8009:8009
    networks:
      - prod_network

  triton:
    container_name: triton
    build:
      context: ./services/triton
      dockerfile: Dockerfile
    volumes:
      - ./services/triton/models:/models
    restart: always
    deploy:
      resources:
        reservations:
          devices:
            - capabilities: [gpu]
    networks:
      - prod_network

  pg_data_wh:
    container_name: pg_data_wh
    image: postgres:15
    restart: always
    ports:
      - "5488:5432"
    volumes:
      - ./services/pg_data_wh:/var/lib/postgresql/data
    networks:
      - prod_network
    env_file: 
      - secrets.txt

  grafana:
    container_name: grafana_traffic
    image: grafana/grafana:latest
    environment:
      TZ: "Europe/Moscow"
      GF_ALLOW_EMBEDDING: "true"
      GF_PANELS_DISABLE_SANITIZE_HTML: "true"
    restart: unless-stopped
    ports:
      - "3111:3000"
    volumes:
      - ./services/grafana:/var/lib/grafana
    networks:
      - prod_network
    env_file: 
      - secrets.txt

volumes:
  pg_data_wh:
  pg_grafana:
  grafana:

networks:
  prod_network:
    driver: bridge
